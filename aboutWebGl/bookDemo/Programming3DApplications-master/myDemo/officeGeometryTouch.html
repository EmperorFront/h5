<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>黄叔叔的天空盒</title>


    <script src="../libs/jquery-1.9.1/jquery-1.9.1.js"></script>
    <script src="../libs/three.js.r58/threeDemoUse.js"></script>
    <script src="../libs/three.js.r58/controls/OrbitControls.js"></script>
    <script src="../libs/three.js.r58/controls/DeviceOrientationControls.js"></script>
    <script src="../libs/requestAnimationFrame/RequestAnimationFrame.js"></script>
    <script type="text/javascript">

        //视角场景
        var renderer = null,
                scene = null,
                camera = null,
                root = null,
                group = null,
                sphere = null,
                sphereEnvMapped = null,
                orbitControls = null;
                DeviceOrientationControls = null;

             var    clickGeomory = null;

        var mouse = new THREE.Vector2(), INTERSECTED;

        var cubes = [];

        var materials = {};
        var mapUrl = "";
        var map = null;
        var envMap = null;

        //创建映射材质
        function createMaterials() {
            map = null;
            var path = "img/";
            var urls = [ path + "r1.jpg", path + "l1.jpg",
                path + "t1.jpg", path + "b1.jpg",
                path + "ba1.jpg", path + "f1.jpg" ];
            envMap = THREE.ImageUtils.loadTextureCube( urls );
            materials["phong"] = new THREE.MeshBasicMaterial( { color: 0xffffff, map: map } );
            materials["phong-envmapped"] = new THREE.MeshBasicMaterial( { color: 0xffffff, envMap : envMap,
                map: map, reflectivity:1.3} );
        }

        //创建小点击几何体
        function createCubes() {

            clickGeomory = new THREE.Object3D;

            function addCubes(times){
                for(var i = 0; i < times; i++ ){
                    var cubeGeometry = new THREE.BoxGeometry(10,10,10);
                    var cubeMaterial = new THREE.MeshLambertMaterial({color:0xff0000});
                    var cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
                    cubes.push(cube);
                    cube.position.set(getRandom(100), getRandom(100), getRandom(100));

                    clickGeomory.add(cube);
                }
                scene.add(clickGeomory);
            }
            function getRandom (absolute){
                return parseInt(Math.random() * absolute * 2 - absolute);
            }
            addCubes(10);
        }
        var materialName = "phong-envmapped";
        var envMapOn = true;
        function setMaterial(name) {
            materialName = name;
            if (envMapOn)
            {
                sphere.visible = false;
                sphereEnvMapped.visible = true;
                sphereEnvMapped.material = materials[name];
            }
            else
            {
                sphere.visible = true;
                sphereEnvMapped.visible = false;
                sphere.material = materials[name];
            }
        }
        function createScene(canvas) {
            renderer = new THREE.WebGLRenderer( { canvas: canvas, antialias: true } );
            renderer.setSize(canvas.width, canvas.height);
            scene = new THREE.Scene();
            //添加透视相机
            camera = new THREE.PerspectiveCamera( 75, canvas.width / canvas.height, 1, 1000 );
            camera.position.z = 0;
            camera.position.x = 0;
            camera.position.y = 0;
            var helper = new THREE.CameraHelper( camera );
            scene.add( helper );
            scene.add(camera);

            // 创建一个用于承载所有对象的根目录
            root = new THREE.Object3D;
            // Add a directional light to show off the object
            var light = new THREE.DirectionalLight( 0xffffff, 2);

            root.add(light);
            var spotLight = new THREE.SpotLight( 0xffffff );
            spotLight.position.set(-40, 60, -10);
            root.add( spotLight );
            scene.add( spotLight );
            // Create a group to hold the spheres
            group = new THREE.Object3D;
            root.add(group);

            //创建映射材质
            createMaterials();

            geometry = new THREE.SphereGeometry(2, 20, 20);
            // 创建天空盒
            var shader = THREE.ShaderLib[ "cube" ];
            shader.uniforms[ "tCube" ].value = envMap;
            var material = new THREE.ShaderMaterial( {
                        fragmentShader: shader.fragmentShader,
                        vertexShader: shader.vertexShader,
                        uniforms: shader.uniforms,
                        side: THREE.BackSide
                    } ),
                    mesh = new THREE.Mesh( new THREE.CubeGeometry( 500, 500, 500 ), material );
            scene.add( mesh );
            // Now add the group to our scene
            //scene.add( root );

            //添加点击几何体
            createCubes();
        }
        function initControls()
        {
            orbitControls = new THREE.OrbitControls(camera, renderer.domElement);
            DeviceOrientationControls = controls = new THREE.DeviceOrientationControls( camera );


            //这几行含义未知
            raycaster = new THREE.Raycaster();

            //下边是渲染器
            //renderer = new THREE.WebGLRenderer();
            //renderer.setClearColor( 0xf0f0f0 );
            //renderer.setPixelRatio( window.devicePixelRatio );
            //renderer.setSize( window.innerWidth, window.innerHeight );
//        renderer.sortObjects = false;
            container.appendChild(renderer.domElement);


           //启动对鼠标的监听
            document.addEventListener( 'mousemove', onDocumentMouseMove, false );
        }
        function onDocumentMouseMove( event ) {
            mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
            mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
        }

        function run() {
            requestAnimationFrame(function() { run(); });
            for(var i = 0; i < cubes.length; i++){
                cubes[i].rotation.x += 0.02;
                cubes[i].rotation.y += 0.02;
                cubes[i].rotation.z += 0.02;
            }

//            设定射线，传入鼠标，相机。
            raycaster.setFromCamera( mouse, camera );
            var intersects = raycaster.intersectObjects( clickGeomory.children );
            if(intersects.length)
            console.log(intersects);

            if ( intersects.length > 0 ) {
                if ( INTERSECTED != intersects[ 0 ].object ) {
                    if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
                    INTERSECTED = intersects[ 0 ].object;
                    //debugger;
                    console.log(intersects);
                    INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
                    //debugger;
                    INTERSECTED.material.emissive.setHex( 0xffffff );
                    INTERSECTED.material.emissive.delate();


                }
            } else {
                console.log(intersects);
                //if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
                //INTERSECTED = null;
            }


            renderer.render( scene, camera );
            DeviceOrientationControls.update();
        }

        $(document).ready(
                function() {
                    window.addEventListener('deviceorientation', function(event) {
                        html = '';
                        alpha = event.alpha;
                        beta = event.beta;
                        gamma = event.gamma;
                    }, false)
                    var canvas = document.getElementById("webglcanvas");
                    createScene(canvas);
                    initControls();
                    run();
                }
        );
    </script>

</head>
<body>

<div id="container">
    <canvas id="webglcanvas" width=800 height=600></canvas>
</div>
</body>
</html>